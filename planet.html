<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>AR Planet Explorer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <!-- A-Frame and AR.js -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', 'Arial', sans-serif; }
        a-scene canvas { touch-action: none; }

        /* ===== GLASSMORPHISM STYLES ===== */
        .glass-panel {
            background: rgba(20, 30, 45, 0.45);
            backdrop-filter: blur(12px) saturate(180%);
            -webkit-backdrop-filter: blur(12px) saturate(180%);
            border: 1.5px solid rgba(255, 255, 255, 0.25);
            border-radius: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5), inset 0 1px 3px rgba(255,255,255,0.2);
            color: white;
            text-shadow: 0 2px 5px rgba(0,0,0,0.4);
            transition: all 0.2s ease;
        }

        #info-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            max-width: 520px;
            margin: 0 auto;
            padding: 22px 25px;
            z-index: 1000;
            pointer-events: auto;
            transform: translateY(0);
            opacity: 1;
            transition: transform 0.35s cubic-bezier(0.2, 0.9, 0.3, 1), opacity 0.25s;
        }
        #info-panel.hidden {
            transform: translateY(120%);
            opacity: 0;
            pointer-events: none;
        }
        #info-panel h2 {
            margin: 0 0 12px;
            font-size: 2.2rem;
            font-weight: 500;
            letter-spacing: 1px;
            text-shadow: 0 0 12px #7fc9ff;
            padding-right: 35px;
            color: #fff;
        }
        #info-panel p {
            margin: 10px 0;
            font-size: 1.15rem;
            font-weight: 350;
            line-height: 1.5;
            color: rgba(255,255,255,0.95);
        }
        .close-btn {
            position: absolute;
            top: 18px;
            right: 22px;
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            font-size: 2rem;
            cursor: pointer;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            transition: 0.2s;
            backdrop-filter: blur(8px);
            font-family: 'Arial', sans-serif;
        }
        .close-btn:hover {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.8);
            transform: scale(1.05);
        }
        .read-btn {
            background: rgba(42, 74, 122, 0.7);
            backdrop-filter: blur(8px);
            border: 1.5px solid rgba(138, 179, 255, 0.7);
            color: white;
            padding: 14px 25px;
            font-size: 1.25rem;
            border-radius: 50px;
            cursor: pointer;
            margin-top: 18px;
            transition: 0.3s;
            width: 100%;
            font-weight: 500;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 12px rgba(0, 30, 60, 0.6);
        }
        .read-btn:hover {
            background: rgba(58, 110, 165, 0.9);
            border-color: #aac9ff;
            box-shadow: 0 0 20px #5a9eff;
        }
        .read-btn.stopping {
            background: rgba(160, 60, 60, 0.8);
            border-color: #ffa07a;
        }

        #toggle-info {
            position: absolute;
            bottom: 25px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(20, 30, 45, 0.6);
            backdrop-filter: blur(16px) saturate(200%);
            border: 2px solid rgba(138, 179, 255, 0.7);
            border-radius: 60px;
            padding: 14px 35px;
            font-size: 1.25rem;
            cursor: pointer;
            z-index: 1001;
            box-shadow: 0 0 25px rgba(0, 160, 255, 0.6);
            display: none;
            color: white;
            font-weight: 500;
            letter-spacing: 0.5px;
            transition: 0.2s;
        }
        #toggle-info:hover {
            background: rgba(42, 74, 122, 0.8);
            border-color: #b0d0ff;
        }

        .back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.35);
            backdrop-filter: blur(12px);
            color: white;
            padding: 12px 24px;
            border-radius: 40px;
            text-decoration: none;
            z-index: 1001;
            border: 1.5px solid rgba(138, 179, 255, 0.5);
            font-size: 1.1rem;
            font-weight: 500;
            transition: 0.2s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.4);
        }
        .back-btn:hover {
            background: rgba(30, 50, 80, 0.7);
            border-color: #8ab3ff;
        }

        .debug-hint {
            position: absolute;
            top: 90px;
            left: 20px;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(4px);
            color: #b0ffb0;
            padding: 6px 15px;
            border-radius: 30px;
            font-size: 0.85rem;
            z-index: 1000;
            border: 1px solid #3a6ea5;
            letter-spacing: 0.3px;
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-btn">Home</a>
    <div class="debug-hint" id="debug-status">Waiting for HIRO marker...</div>
    <script src="ai-chatbot.js"></script>
    <!-- Toggle button (appears when info panel is hidden) - no emoji -->
    <button id="toggle-info">Show Info</button>

    <!-- Robust gesture handler (scale + rotate) with multi-touch -->
    <script>
        AFRAME.registerComponent('gesture-control', {
            init: function () {
                const targetEl = document.getElementById('planet-system');
                if (!targetEl) {
                    console.warn('planet-system not found');
                    return;
                }

                const THREE = AFRAME.THREE;
                let scale = 1;
                let startDistance = 0;
                let lastTouchCenter = null;
                let isPinching = false;
                let startScale = 1;

                // Ensure initial transform
                targetEl.object3D.position.set(0, 0, 0);
                targetEl.object3D.scale.set(1, 1, 1);

                const canvas = this.el.canvas;
                canvas.addEventListener('touchstart', onTouchStart, { passive: false });
                canvas.addEventListener('touchmove', onTouchMove, { passive: false });
                canvas.addEventListener('touchend', onTouchEnd);
                canvas.addEventListener('touchcancel', onTouchEnd);

                function onTouchStart(e) {
                    if (e.touches.length === 2) {
                        e.preventDefault();
                        isPinching = true;
                        const t1 = e.touches[0];
                        const t2 = e.touches[1];
                        const dx = t1.clientX - t2.clientX;
                        const dy = t1.clientY - t2.clientY;
                        startDistance = Math.sqrt(dx * dx + dy * dy);
                        lastTouchCenter = {
                            x: (t1.clientX + t2.clientX) / 2,
                            y: (t1.clientY + t2.clientY) / 2,
                            angle: Math.atan2(dy, dx)
                        };
                        startScale = scale;
                    }
                }

                function onTouchMove(e) {
                    if (!isPinching || e.touches.length !== 2) return;
                    e.preventDefault();

                    const t1 = e.touches[0];
                    const t2 = e.touches[1];
                    const dx = t1.clientX - t2.clientX;
                    const dy = t1.clientY - t2.clientY;
                    const distance = Math.sqrt(dx * dx + dy * dy);

                    // Scale
                    const scaleFactor = distance / startDistance;
                    scale = startScale * scaleFactor;
                    scale = Math.max(0.2, Math.min(20, scale));
                    targetEl.object3D.scale.set(scale, scale, scale);

                    // Rotation based on center movement
                    const centerX = (t1.clientX + t2.clientX) / 2;
                    const centerY = (t1.clientY + t2.clientY) / 2;
                    if (lastTouchCenter) {
                        const deltaX = centerX - lastTouchCenter.x;
                        const deltaY = centerY - lastTouchCenter.y;
                        const rotSpeed = 0.008;

                        if (Math.abs(deltaX) > 0.5) {
                            targetEl.object3D.rotateY(deltaX * rotSpeed);
                        }
                        if (Math.abs(deltaY) > 0.5) {
                            targetEl.object3D.rotateX(deltaY * rotSpeed);
                        }

                        // Twist (roll)
                        const currentAngle = Math.atan2(dy, dx);
                        const deltaAngle = currentAngle - lastTouchCenter.angle;
                        if (Math.abs(deltaAngle) > 0.01) {
                            targetEl.object3D.rotateZ(deltaAngle * 0.3);
                        }
                        lastTouchCenter.angle = currentAngle;
                    }
                    lastTouchCenter.x = centerX;
                    lastTouchCenter.y = centerY;
                }

                function onTouchEnd(e) {
                    if (e.touches.length < 2) {
                        isPinching = false;
                        lastTouchCenter = null;
                    }
                }
            }
        });
    </script>

    <!-- A-Frame Scene with extra lighting for bright models -->
    <a-scene embedded
             arjs="sourceType: webcam; detectionMode: mono; matrixCodeType: 3x3; debugUIEnabled: false; trackingMethod: best;"
             renderer="antialias: true; alpha: true;"
             gesture-control
             vr-mode-ui="enabled: false">   <!-- VR UI disabled -->

        <a-entity camera></a-entity>

        <!-- HIRO marker -->
        <a-marker preset="hiro" id="planet-marker" emitevents="true" registerevents>
            <!-- Strong ambient to fill shadows -->
            <a-light type="ambient" color="#ffffff" intensity="0.8"></a-light>
            <!-- Main directional light from top-front -->
            <a-light type="directional" color="#fff4e6" intensity="1.5" position="2 3 4"></a-light>
            <!-- Additional fill lights to wrap around -->
            <a-light type="point" intensity="1.2" position="2 1 2" color="#aaccff"></a-light>
            <a-light type="point" intensity="1.0" position="-2 1 -2" color="#ffccaa"></a-light>
            <!-- Extra light near the sun position (though sun not here) -->
            <a-light type="point" intensity="1.5" position="1 2 0" color="#ffffff"></a-light>

            <!-- Planet system container (all planets/moons will be injected here) -->
            <a-entity id="planet-system"></a-entity>
        </a-marker>
    </a-scene>

    <!-- Info panel (filled dynamically) -->
    <div id="info-panel" class="glass-panel"></div>

    <script>
        (function() {
            const debug = document.getElementById('debug-status');
            const marker = document.getElementById('planet-marker');
            const planetSystem = document.getElementById('planet-system');
            const infoPanel = document.getElementById('info-panel');
            const toggleBtn = document.getElementById('toggle-info');

            // Get planet name from URL (?name=earth)
            const urlParams = new URLSearchParams(window.location.search);
            const planetKey = urlParams.get('name') || 'earth';

            // Extended planet data with moons (same as original but ensure colors)
            const planetData = {
                mercury: {
                    name: 'Mercury',
                    diameter: '4,879 km',
                    distance: '57.9 million km',
                    dayLength: '58.6 Earth days',
                    yearLength: '88 Earth days',
                    moons: 0,
                    texture: 'mercury.jpg',
                    ring: false,
                    moonList: []
                },
                venus: {
                    name: 'Venus',
                    diameter: '12,104 km',
                    distance: '108.2 million km',
                    dayLength: '243 Earth days',
                    yearLength: '225 Earth days',
                    moons: 0,
                    texture: 'venus.jpg',
                    ring: false,
                    moonList: []
                },
                earth: {
                    name: 'Earth',
                    diameter: '12,742 km',
                    distance: '149.6 million km',
                    dayLength: '24 hours',
                    yearLength: '365 days',
                    moons: 1,
                    texture: 'earth.jpg',
                    ring: false,
                    moonList: [
                        { name: 'Luna', radius: 0.06, distance: 0.45, color: '#dddddd', speed: 3000 }
                    ]
                },
                mars: {
                    name: 'Mars',
                    diameter: '6,779 km',
                    distance: '227.9 million km',
                    dayLength: '24.6 hours',
                    yearLength: '687 Earth days',
                    moons: 2,
                    texture: 'mars.jpg',
                    ring: false,
                    moonList: [
                        { name: 'Phobos', radius: 0.04, distance: 0.4, color: '#b87c4b', speed: 2000 },
                        { name: 'Deimos', radius: 0.03, distance: 0.55, color: '#a06542', speed: 4000 }
                    ]
                },
                jupiter: {
                    name: 'Jupiter',
                    diameter: '139,820 km',
                    distance: '778.5 million km',
                    dayLength: '9.9 hours',
                    yearLength: '11.9 Earth years',
                    moons: 79,
                    texture: 'jupiter.jpg',
                    ring: false,
                    moonList: [
                        { name: 'Io', radius: 0.07, distance: 0.5, color: '#ffaa33', speed: 2000 },
                        { name: 'Europa', radius: 0.06, distance: 0.65, color: '#b0c4de', speed: 3000 },
                        { name: 'Ganymede', radius: 0.08, distance: 0.8, color: '#a0a0a0', speed: 4000 },
                        { name: 'Callisto', radius: 0.07, distance: 0.95, color: '#6b6b6b', speed: 5000 }
                    ]
                },
                saturn: {
                    name: 'Saturn',
                    diameter: '116,460 km',
                    distance: '1.43 billion km',
                    dayLength: '10.7 hours',
                    yearLength: '29.5 Earth years',
                    moons: 82,
                    texture: 'saturn.jpg',
                    ring: true,
                    ringTexture: 'saturn_ring.png',
                    moonList: [
                        { name: 'Titan', radius: 0.09, distance: 0.7, color: '#d2b48c', speed: 3500 },
                        { name: 'Rhea', radius: 0.06, distance: 0.9, color: '#c0c0c0', speed: 4500 },
                        { name: 'Dione', radius: 0.05, distance: 1.1, color: '#b8b8b8', speed: 5500 }
                    ]
                },
                uranus: {
                    name: 'Uranus',
                    diameter: '50,724 km',
                    distance: '2.87 billion km',
                    dayLength: '17.2 hours',
                    yearLength: '84 Earth years',
                    moons: 27,
                    texture: 'uranus.jpg',
                    ring: true,
                    ringTexture: 'uranus_ring.png',
                    moonList: [
                        { name: 'Titania', radius: 0.06, distance: 0.65, color: '#b0e0e6', speed: 4000 },
                        { name: 'Oberon', radius: 0.06, distance: 0.85, color: '#9ac0cd', speed: 5000 }
                    ]
                },
                neptune: {
                    name: 'Neptune',
                    diameter: '49,244 km',
                    distance: '4.5 billion km',
                    dayLength: '16.1 hours',
                    yearLength: '165 Earth years',
                    moons: 14,
                    texture: 'neptune.jpg',
                    ring: false,
                    moonList: [
                        { name: 'Triton', radius: 0.07, distance: 0.6, color: '#5d9b9b', speed: 3500 }
                    ]
                }
            };

            const data = planetData[planetKey];

            if (!data) {
                infoPanel.innerHTML = '<h2>Planet not found</h2>';
                return;
            }

            // ----- Build the planet system (planet + moons) with proper lighting responsiveness -----
            // Planet sphere with self-rotation
            const planetEntity = document.createElement('a-entity');
            planetEntity.setAttribute('position', '0 0 0');

            const sphere = document.createElement('a-sphere');
            sphere.setAttribute('radius', '0.25');
            sphere.setAttribute('material', `src: url(images/${data.texture});`);
            sphere.setAttribute('animation', 'property: rotation; to: 0 360 0; dur: 8000; easing: linear; repeat: indefinite');
            planetEntity.appendChild(sphere);

            // Add planetary ring if present
            if (data.ring) {
                const ring = document.createElement('a-ring');
                ring.setAttribute('radius-inner', '0.35');
                ring.setAttribute('radius-outer', '0.55');
                ring.setAttribute('material', `src: url(images/${data.ringTexture}); transparent: true; side: double;`);
                ring.setAttribute('rotation', '90 0 0');
                ring.setAttribute('position', '0 0 0');
                planetEntity.appendChild(ring);
            }

            planetSystem.appendChild(planetEntity);

            // Moons (each in its own orbit container)
            data.moonList.forEach(moon => {
                const moonOrbit = document.createElement('a-entity');
                moonOrbit.setAttribute('position', '0 0 0');
                moonOrbit.setAttribute('animation', `property: rotation; to: 0 360 0; dur: ${moon.speed * 2}; easing: linear; repeat: indefinite`);

                const moonSphere = document.createElement('a-sphere');
                moonSphere.setAttribute('radius', moon.radius);
                moonSphere.setAttribute('material', `color: ${moon.color}; emissive: #222222`); // slight emissive to catch light
                moonSphere.setAttribute('position', `${moon.distance} 0 0`);
                moonSphere.setAttribute('animation', `property: rotation; to: 0 360 0; dur: 4000; easing: linear; repeat: indefinite`);

                moonOrbit.appendChild(moonSphere);
                planetSystem.appendChild(moonOrbit);
            });

            // Decorative tiny stars around the planet (static relative to planet)
            const stars = document.createElement('a-entity');
            stars.setAttribute('position', '0 0 0');
            for (let i = 0; i < 12; i++) {
                const star = document.createElement('a-sphere');
                star.setAttribute('radius', '0.015');
                star.setAttribute('color', '#fff');
                star.setAttribute('emissive', '#aaa');
                const angle = (i / 12) * Math.PI * 2;
                const rad = 1.6;
                star.setAttribute('position', `${Math.cos(angle)*rad} ${Math.sin(angle)*0.3} ${Math.sin(angle)*rad}`);
                stars.appendChild(star);
            }
            planetSystem.appendChild(stars);

            // ----- Glass info panel content (no emojis) -----
            infoPanel.innerHTML = `
                <button class="close-btn" id="closePanel">X</button>
                <h2>${data.name}</h2>
                <p><strong>Diameter:</strong> ${data.diameter}</p>
                <p><strong>Distance from Sun:</strong> ${data.distance}</p>
                <p><strong>Day length:</strong> ${data.dayLength}</p>
                <p><strong>Year length:</strong> ${data.yearLength}</p>
                <p><strong>Moons:</strong> ${data.moons} (${data.moonList.length} shown in AR)</p>
                <button class="read-btn" id="readBtn">Listen</button>
            `;

            // ----- Panel controls -----
            document.getElementById('closePanel').addEventListener('click', () => {
                infoPanel.classList.add('hidden');
                toggleBtn.style.display = 'block';
            });

            toggleBtn.addEventListener('click', () => {
                infoPanel.classList.remove('hidden');
                toggleBtn.style.display = 'none';
            });

            // ----- Text-to-speech with toggle (Listen / Stop) -----
            const readBtn = document.getElementById('readBtn');
            let utterance = null;

            function stopSpeaking() {
                if (window.speechSynthesis) {
                    window.speechSynthesis.cancel();
                }
                utterance = null;
                readBtn.textContent = 'Listen';
                readBtn.classList.remove('stopping');
            }

            function startSpeaking() {
                const text = `Welcome to ${data.name}. Diameter: ${data.diameter}. Distance from Sun: ${data.distance}. Day length: ${data.dayLength}. Year length: ${data.yearLength}. Number of moons: ${data.moons}.`;
                utterance = new SpeechSynthesisUtterance(text);
                utterance.onend = () => {
                    readBtn.textContent = 'Listen';
                    readBtn.classList.remove('stopping');
                    utterance = null;
                };
                utterance.onerror = () => {
                    readBtn.textContent = 'Listen';
                    readBtn.classList.remove('stopping');
                    utterance = null;
                };
                window.speechSynthesis.speak(utterance);
                readBtn.textContent = 'Stop';
                readBtn.classList.add('stopping');
            }

            readBtn.addEventListener('click', () => {
                if (utterance) {
                    // Currently speaking -> stop
                    stopSpeaking();
                } else {
                    startSpeaking();
                }
            });

            // Marker events
            marker.addEventListener('markerFound', () => {
                debug.innerText = '✅ Marker FOUND – planet active';
                debug.style.color = '#b0ffb0';
            });
            marker.addEventListener('markerLost', () => {
                debug.innerText = '❌ Marker lost – show HIRO';
                debug.style.color = '#ffb0b0';
            });

            // Camera permission check
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(() => console.log('Camera ready'))
                .catch(() => {
                    debug.innerText = '⚠️ Camera access denied';
                    debug.style.color = '#ffa0a0';
                });
        })();
    </script>

    <!-- optional chatbot (external, kept as reference) -->

</body>
</html>