<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>AR Planet Explorer with Moons</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <!-- A-Frame and AR.js -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Arial', sans-serif; }
        a-scene canvas { touch-action: none; }
        #info-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(10, 20, 30, 0.9);
            backdrop-filter: blur(10px);
            color: white;
            padding: 20px;
            border-radius: 30px;
            border: 2px solid #3a6ea5;
            box-shadow: 0 0 30px rgba(0,160,255,0.5);
            z-index: 1000;
            max-width: 500px;
            margin: 0 auto;
            pointer-events: auto;
            transition: transform 0.3s, opacity 0.3s;
        }
        #info-panel.hidden {
            transform: translateY(120%);
            opacity: 0;
            pointer-events: none;
        }
        #info-panel h2 {
            margin: 0 0 10px;
            font-size: 2rem;
            text-shadow: 0 0 10px cyan;
            padding-right: 30px;
        }
        #info-panel p {
            margin: 8px 0;
            font-size: 1.1rem;
        }
        .close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 1.8rem;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            transition: 0.2s;
        }
        .close-btn:hover {
            background: rgba(255,255,255,0.4);
        }
        .read-btn {
            background: #2a4a7a;
            border: none;
            color: white;
            padding: 12px 25px;
            font-size: 1.2rem;
            border-radius: 40px;
            cursor: pointer;
            margin-top: 15px;
            border: 1px solid #8ab3ff;
            transition: 0.3s;
            width: 100%;
        }
        .read-btn:hover {
            background: #3a6ea5;
            box-shadow: 0 0 15px cyan;
        }
        #toggle-info {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(10, 20, 30, 0.9);
            backdrop-filter: blur(10px);
            color: white;
            border: 2px solid #3a6ea5;
            border-radius: 60px;
            padding: 12px 30px;
            font-size: 1.2rem;
            cursor: pointer;
            z-index: 1001;
            box-shadow: 0 0 20px cyan;
            display: none;
            transition: 0.2s;
        }
        #toggle-info:hover {
            background: #2a4a7a;
        }
        .back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.6);
            color: white;
            padding: 10px 20px;
            border-radius: 30px;
            text-decoration: none;
            z-index: 1001;
            border: 1px solid #3a6ea5;
            backdrop-filter: blur(5px);
        }
        .debug-hint {
            position: absolute;
            top: 80px;
            left: 20px;
            background: rgba(0,0,0,0.5);
            color: #0f0;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <a href="planets.html" class="back-btn">‚Üê Planets</a>
    <div class="debug-hint" id="debug-status">Waiting for marker...</div>

    <!-- Toggle button (visible when panel hidden) -->
    <button id="toggle-info">üåç Show Planet Info</button>

    <!-- Robust gesture handler for scaling and rotation -->
    <script>
        AFRAME.registerComponent('gesture-control', {
            init: function () {
                const targetEl = document.getElementById('planet-system');
                if (!targetEl) {
                    console.warn('planet-system not found');
                    return;
                }

                const THREE = AFRAME.THREE;
                let scale = 1;
                let startDistance = 0;
                let lastTouchCenter = null;
                let isPinching = false;
                let startScale = 1;

                // Ensure initial position and scale
                targetEl.object3D.position.set(0, 0, 0);
                targetEl.object3D.scale.set(1, 1, 1);

                const canvas = this.el.canvas;
                canvas.addEventListener('touchstart', onTouchStart, { passive: false });
                canvas.addEventListener('touchmove', onTouchMove, { passive: false });
                canvas.addEventListener('touchend', onTouchEnd);
                canvas.addEventListener('touchcancel', onTouchEnd);

                function onTouchStart(e) {
                    if (e.touches.length === 2) {
                        e.preventDefault();
                        isPinching = true;
                        const t1 = e.touches[0];
                        const t2 = e.touches[1];
                        const dx = t1.clientX - t2.clientX;
                        const dy = t1.clientY - t2.clientY;
                        startDistance = Math.sqrt(dx * dx + dy * dy);
                        lastTouchCenter = {
                            x: (t1.clientX + t2.clientX) / 2,
                            y: (t1.clientY + t2.clientY) / 2,
                            angle: Math.atan2(dy, dx)
                        };
                        startScale = scale;
                    }
                }

                function onTouchMove(e) {
                    if (!isPinching || e.touches.length !== 2) return;
                    e.preventDefault();

                    const t1 = e.touches[0];
                    const t2 = e.touches[1];
                    const dx = t1.clientX - t2.clientX;
                    const dy = t1.clientY - t2.clientY;
                    const distance = Math.sqrt(dx * dx + dy * dy);

                    // Scale
                    const scaleFactor = distance / startDistance;
                    scale = startScale * scaleFactor;
                    scale = Math.max(0.2, Math.min(20, scale));
                    targetEl.object3D.scale.set(scale, scale, scale);

                    // Rotation based on center movement
                    const centerX = (t1.clientX + t2.clientX) / 2;
                    const centerY = (t1.clientY + t2.clientY) / 2;
                    if (lastTouchCenter) {
                        const deltaX = centerX - lastTouchCenter.x;
                        const deltaY = centerY - lastTouchCenter.y;
                        const rotSpeed = 0.008;

                        // Apply rotations around world axes
                        if (Math.abs(deltaX) > 0.5) {
                            targetEl.object3D.rotateY(deltaX * rotSpeed); // yaw
                        }
                        if (Math.abs(deltaY) > 0.5) {
                            targetEl.object3D.rotateX(deltaY * rotSpeed); // pitch
                        }

                        // Small roll from finger twist
                        const currentAngle = Math.atan2(dy, dx);
                        const deltaAngle = currentAngle - lastTouchCenter.angle;
                        if (Math.abs(deltaAngle) > 0.01) {
                            targetEl.object3D.rotateZ(deltaAngle * 0.3);
                        }
                        lastTouchCenter.angle = currentAngle;
                    }
                    lastTouchCenter.x = centerX;
                    lastTouchCenter.y = centerY;
                }

                function onTouchEnd(e) {
                    if (e.touches.length < 2) {
                        isPinching = false;
                        lastTouchCenter = null;
                    }
                }
            }
        });
    </script>

    <!-- A-Frame Scene -->
    <a-scene embedded
             arjs="sourceType: webcam; detectionMode: mono; matrixCodeType: 3x3; debugUIEnabled: false; trackingMethod: best;"
             renderer="antialias: true; alpha: true;"
             gesture-control
             vr-mode-ui="enabled: false">

        <a-entity camera></a-entity>

        <a-marker preset="hiro" id="planet-marker" emitevents="true" registerevents>
            <a-light type="ambient" color="#ffffff" intensity="0.3"></a-light>
            <a-light type="point" intensity="2" position="0 0 0" color="#ffaa00"></a-light>

            <!-- Planet system container (will be transformed) -->
            <a-entity id="planet-system"></a-entity>
        </a-marker>
    </a-scene>

    <!-- Info panel (filled dynamically) -->
    <div id="info-panel"></div>

    <script>
        (function() {
            const debug = document.getElementById('debug-status');
            const marker = document.getElementById('planet-marker');
            const planetSystem = document.getElementById('planet-system');
            const infoPanel = document.getElementById('info-panel');
            const toggleBtn = document.getElementById('toggle-info');

            // Planet data with moons
            const planetData = {
                mercury: {
                    name: 'Mercury',
                    diameter: '4,879 km',
                    distance: '57.9 million km',
                    dayLength: '58.6 Earth days',
                    yearLength: '88 Earth days',
                    moons: 0,
                    texture: 'mercury.jpg',
                    ring: false,
                    moonList: []
                },
                venus: {
                    name: 'Venus',
                    diameter: '12,104 km',
                    distance: '108.2 million km',
                    dayLength: '243 Earth days',
                    yearLength: '225 Earth days',
                    moons: 0,
                    texture: 'venus.jpg',
                    ring: false,
                    moonList: []
                },
                earth: {
                    name: 'Earth',
                    diameter: '12,742 km',
                    distance: '149.6 million km',
                    dayLength: '24 hours',
                    yearLength: '365 days',
                    moons: 1,
                    texture: 'earth.jpg',
                    ring: false,
                    moonList: [
                        { name: 'Luna', radius: 0.06, distance: 0.45, color: '#ccc', speed: 3000 }
                    ]
                },
                mars: {
                    name: 'Mars',
                    diameter: '6,779 km',
                    distance: '227.9 million km',
                    dayLength: '24.6 hours',
                    yearLength: '687 Earth days',
                    moons: 2,
                    texture: 'mars.jpg',
                    ring: false,
                    moonList: [
                        { name: 'Phobos', radius: 0.04, distance: 0.4, color: '#a52a2a', speed: 2000 },
                        { name: 'Deimos', radius: 0.03, distance: 0.55, color: '#8b4513', speed: 4000 }
                    ]
                },
                jupiter: {
                    name: 'Jupiter',
                    diameter: '139,820 km',
                    distance: '778.5 million km',
                    dayLength: '9.9 hours',
                    yearLength: '11.9 Earth years',
                    moons: 79,
                    texture: 'jupiter.jpg',
                    ring: false,
                    moonList: [
                        { name: 'Io', radius: 0.07, distance: 0.5, color: '#ffa500', speed: 2000 },
                        { name: 'Europa', radius: 0.06, distance: 0.65, color: '#c0c0c0', speed: 3000 },
                        { name: 'Ganymede', radius: 0.08, distance: 0.8, color: '#a9a9a9', speed: 4000 },
                        { name: 'Callisto', radius: 0.07, distance: 0.95, color: '#696969', speed: 5000 }
                    ]
                },
                saturn: {
                    name: 'Saturn',
                    diameter: '116,460 km',
                    distance: '1.43 billion km',
                    dayLength: '10.7 hours',
                    yearLength: '29.5 Earth years',
                    moons: 82,
                    texture: 'saturn.jpg',
                    ring: true,
                    ringTexture: 'saturn_ring.png',
                    moonList: [
                        { name: 'Titan', radius: 0.09, distance: 0.7, color: '#ffd700', speed: 3500 },
                        { name: 'Rhea', radius: 0.06, distance: 0.9, color: '#d3d3d3', speed: 4500 },
                        { name: 'Dione', radius: 0.05, distance: 1.1, color: '#b0c4de', speed: 5500 }
                    ]
                },
                uranus: {
                    name: 'Uranus',
                    diameter: '50,724 km',
                    distance: '2.87 billion km',
                    dayLength: '17.2 hours',
                    yearLength: '84 Earth years',
                    moons: 27,
                    texture: 'uranus.jpg',
                    ring: true,
                    ringTexture: 'uranus_ring.png',
                    moonList: [
                        { name: 'Titania', radius: 0.06, distance: 0.65, color: '#e6e6fa', speed: 4000 },
                        { name: 'Oberon', radius: 0.06, distance: 0.85, color: '#b0e0e6', speed: 5000 }
                    ]
                },
                neptune: {
                    name: 'Neptune',
                    diameter: '49,244 km',
                    distance: '4.5 billion km',
                    dayLength: '16.1 hours',
                    yearLength: '165 Earth years',
                    moons: 14,
                    texture: 'neptune.jpg',
                    ring: false,
                    moonList: [
                        { name: 'Triton', radius: 0.07, distance: 0.6, color: '#4682b4', speed: 3500 }
                    ]
                }
            };

            // Get planet name from URL
            const urlParams = new URLSearchParams(window.location.search);
            const planetKey = urlParams.get('name') || 'earth';
            const data = planetData[planetKey];

            if (!data) {
                infoPanel.innerHTML = '<h2>Planet not found</h2>';
                return;
            }

            // Create the planet system content (planet + moons)
            // We'll add everything directly to planetSystem so that gestures affect all.

            // Planet sphere (with self-rotation)
            const planetEntity = document.createElement('a-entity');
            planetEntity.setAttribute('position', '0 0 0');

            const sphere = document.createElement('a-sphere');
            sphere.setAttribute('radius', '0.25');
            sphere.setAttribute('material', `src: url(images/${data.texture});`);
            sphere.setAttribute('animation', `property: rotation; to: 0 360 0; dur: 8000; easing: linear; repeat: indefinite`);
            planetEntity.appendChild(sphere);

            // Add ring if needed
            if (data.ring) {
                const ring = document.createElement('a-ring');
                ring.setAttribute('radius-inner', '0.35');
                ring.setAttribute('radius-outer', '0.55');
                ring.setAttribute('material', `src: url(images/${data.ringTexture}); transparent: true; side: double;`);
                ring.setAttribute('rotation', '90 0 0');
                ring.setAttribute('position', '0 0 0');
                planetEntity.appendChild(ring);
            }

            planetSystem.appendChild(planetEntity);

            // Moons
            data.moonList.forEach(moon => {
                // Container that rotates around planet
                const moonOrbit = document.createElement('a-entity');
                moonOrbit.setAttribute('position', '0 0 0');
                moonOrbit.setAttribute('animation', `property: rotation; to: 0 360 0; dur: ${moon.speed * 2}; easing: linear; repeat: indefinite`);

                const moonSphere = document.createElement('a-sphere');
                moonSphere.setAttribute('radius', moon.radius);
                moonSphere.setAttribute('material', `color: ${moon.color}`);
                moonSphere.setAttribute('position', `${moon.distance} 0 0`);
                // Moon self-spin
                moonSphere.setAttribute('animation', `property: rotation; to: 0 360 0; dur: 4000; easing: linear; repeat: indefinite`);

                moonOrbit.appendChild(moonSphere);
                planetSystem.appendChild(moonOrbit);
            });

            // Decorative stars around the planet (static relative to planet)
            const stars = document.createElement('a-entity');
            stars.setAttribute('position', '0 0 0');
            for (let i = 0; i < 10; i++) {
                const star = document.createElement('a-sphere');
                star.setAttribute('radius', '0.02');
                star.setAttribute('color', '#fff');
                const angle = (i / 10) * Math.PI * 2;
                const rad = 1.5;
                star.setAttribute('position', `${Math.cos(angle)*rad} ${Math.sin(angle)*0.5} ${Math.sin(angle)*rad}`);
                stars.appendChild(star);
            }
            planetSystem.appendChild(stars);

            // Build info panel
            infoPanel.innerHTML = `
                <button class="close-btn" id="closePanel">‚úï</button>
                <h2>${data.name}</h2>
                <p><strong>Diameter:</strong> ${data.diameter}</p>
                <p><strong>Distance from Sun:</strong> ${data.distance}</p>
                <p><strong>Day length:</strong> ${data.dayLength}</p>
                <p><strong>Year length:</strong> ${data.yearLength}</p>
                <p><strong>Moons:</strong> ${data.moons} (${data.moonList.length} shown in AR)</p>
                <button class="read-btn" id="readBtn">üîä Read Aloud</button>
            `;

            // Close panel functionality
            document.getElementById('closePanel').addEventListener('click', () => {
                infoPanel.classList.add('hidden');
                toggleBtn.style.display = 'block';
            });

            // Toggle button to reopen
            toggleBtn.addEventListener('click', () => {
                infoPanel.classList.remove('hidden');
                toggleBtn.style.display = 'none';
            });

            // Text-to-speech
            document.getElementById('readBtn').addEventListener('click', () => {
                const text = `Welcome to ${data.name}. Diameter: ${data.diameter}. Distance from Sun: ${data.distance}. Day length: ${data.dayLength}. Year length: ${data.yearLength}. Number of moons: ${data.moons}.`;
                const utterance = new SpeechSynthesisUtterance(text);
                window.speechSynthesis.speak(utterance);
            });

            // Marker events
            marker.addEventListener('markerFound', () => {
                debug.innerText = '‚úÖ Marker FOUND!';
                debug.style.color = '#0f0';
            });
            marker.addEventListener('markerLost', () => {
                debug.innerText = '‚ùå Marker lost ‚Äì show HIRO';
                debug.style.color = '#ff0';
            });

            // Camera access check
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(() => console.log('Camera ready'))
                .catch(() => {
                    debug.innerText = '‚ö†Ô∏è Camera access denied';
                    debug.style.color = '#f00';
                });
        })();
    </script>
</body>
</html>